generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ---------- ENUMS ----------
 */

enum Role {
  USER
  ADMIN
}

enum AppointmentStatus {
  PENDING // form filled but payment not done
  CONFIRMED // payment successful
  CANCELLED
  COMPLETED
}

enum ServiceType {
  NUTRITION
  FITNESS
  DIET_PLAN
}

enum StorageProvider {
  CLOUDINARY
  S3
  LOCAL
}

/**
 * ---------- MODELS ----------
 */

model User {
  id           String        @id @default(uuid())
  name         String
  phone        String        @unique
  role         Role          @default(USER)
  appointments Appointment[] @relation("UserAppointments")
  forms        UserForm[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Doctor {
  id             String        @id @default(uuid())
  name           String
  phone          String?       @unique
  specialization String?
  bio            String?
  clinicAddress  String?
  appointments   Appointment[] @relation("DoctorAppointments")
  slots          Slot[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

model Admin {
  id        String   @id @default(uuid())
  name      String
  phone     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/**
 * ---------- CORE BOOKING MODELS ----------
 */

model Slot {
  id          String       @id @default(uuid())
  doctor      Doctor       @relation(fields: [doctorId], references: [id])
  doctorId    String
  startAt     DateTime
  endAt       DateTime
  serviceType ServiceType
  isBooked    Boolean      @default(false)
  appointment Appointment?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([doctorId, startAt])
}

model Appointment {
  id       String            @id @default(uuid())
  service  ServiceType
  startAt  DateTime
  endAt    DateTime
  status   AppointmentStatus @default(PENDING)
  user     User              @relation(fields: [userId], references: [id], name: "UserAppointments")
  userId   String
  doctor   Doctor            @relation(fields: [doctorId], references: [id], name: "DoctorAppointments")
  doctorId String
  slot     Slot?             @relation(fields: [slotId], references: [id])
  slotId   String?           @unique // one-to-one, each appointment linked to one slot

  form         UserForm?
  paymentId    String?
  amount       Int?
  meetingUrl   String?
  reminderSent Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([startAt])
  @@index([doctorId, startAt])
}

model UserForm {
  id            String       @id @default(uuid())
  user          User         @relation(fields: [userId], references: [id])
  userId        String
  slotId        String? // link to selected slot before payment
  formData      Json
  files         File[]
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
  appointmentId String?      @unique
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

model File {
  id          String          @id @default(uuid())
  url         String
  fileName    String
  mimeType    String
  sizeInBytes Int
  provider    StorageProvider @default(CLOUDINARY)
  userForm    UserForm        @relation(fields: [userFormId], references: [id])
  userFormId  String
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}
